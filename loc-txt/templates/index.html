<!DOCTYPE html>
<html>
<head>
  <title>loc相册</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="/static/images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/static/images/favicon.ico" type="image/x-icon">
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/main.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/js-cookie/3.0.1/js.cookie.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdui@1.0.2/dist/css/mdui.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/mdui@1.0.2/dist/js/mdui.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<body>
  <div class="main mdui-ripple">
    
    <div class="mdui-appbar .mdui-appbar-scroll-hide mdui-appbar-fixed">
      <div class="mdui-toolbar">
        <a href="javascript:;" class="mdui-typo-title">loc云卡</a>
        <p></p>
        <div class="mdui-toolbar-spacer"></div>
        <p style="cursor: grab;" mdui-dialog="{target: '#example-3'}" mdui-dialog="{target: '#example-3'}"><i class="mdui-icon material-icons">&#xe251;</i>上传图片</p>
        <p mdui-dialog="{target: '#example-4'}" style="cursor: grab;"></p>
      
      </div>
    
      
    </div>
    

    <!--注册登陆框-->
    <div class="mdui-dialog" id="example-4">
      <div class="mdui-tab mdui-tab-full-width" id="example4-tab">
        <a href="#example4-tab1" class="mdui-ripple">登陆</a>
        <a href="#example4-tab2" class="mdui-ripple">注册</a>
      </div>
      <div id="example4-tab1" class="mdui-p-a-2">
       
            <div class="mdui-textfield">
              <input id="yhm" class="mdui-textfield-input" type="text" name="username" placeholder="请输入用户名"/>
            </div>
            <div class="mdui-textfield">
              <input id="mm" class="mdui-textfield-input" type="password" name="password" placeholder="密码">
            </div>
            <div class="mdui-col">
              <button id="dl" class="mdui-btn mdui-btn-block mdui-color-theme-accent mdui-ripple" type="submit" value='登   录'>登陆</button>
            </div>


      </div>
      <div id="example4-tab2" class="mdui-p-a-2">

          <div class="mdui-textfield">
            <input id="yhm1"class="mdui-textfield-input" type="text" name="username" placeholder="请输入用户名"/>
          </div>
          <div class="mdui-textfield">
            <input id="mm1" class="mdui-textfield-input" type="password" name="password" placeholder="密码">
          </div>
          <div class="mdui-col">
            <button id="zc" class="mdui-btn mdui-btn-block mdui-color-theme-accent mdui-ripple" type="submit">注册</button>
          </div>

      </div>
    </div>
     <!--注册登陆框结束-->
    

  

    <div class="mdui-dialog" id="example-3">
      <div class="mdui-tab mdui-tab-full-width" id="example3-tab">
        <a href="#example4-tab1" class="mdui-ripple">上传图片</a>
      </div>

        <p id="mz1" name="yhm"></p>
      <!--  <input id="fl" type="file" name="file" value="选择上传文件..." style="width:100%;" class="mdui-btn mdui-btn-raised .mdui-container-fluid"/>--> 

        <div class="mdui-col"><div class="mdui-btn mdui-btn-block mdui-ripple mdui-color-light-blue-50"><span class="mdui-chip-title" onclick="fl.click()">上传图片</span></div></div>

        <input type="file" id="fl" name="file"style="display:none" onchange="filedir.value=this.value"> 
       
   
    
    </div>




     
 
    <div class="container">
    
        <div class="row">

               
        </div>
     
    </div>
    <div class="mdui-divider"></div>
    
  </div>


<script>

  
  if (Cookies.get("username")==undefined){
    mdui.snackbar("建议您登陆")
    document.getElementsByTagName("p")[2].innerHTML='<i class="mdui-icon material-icons">&#xe88e;</i>未登录';
  }else{
    var data = {
        'yhm':Cookies.get("username"),
        'mm':Cookies.get("password")
    }
    $.post("/login",data=data,function(result){
      if(result=="200"){
        mdui.snackbar("欢迎您！")
        document.getElementById("mz1").innerHTML = Cookies.get("username")
        document.getElementById("example-4").innerHTML=""
        document.getElementsByTagName("p")[2].innerHTML='<i class="mdui-icon material-icons">&#xe7ef;</i>'+Cookies.get("username")+'(退出)'
        
        document.getElementsByTagName("p")[2].onclick=function(){
          Cookies.remove("username")
          Cookies.remove("password")
          mdui.snackbar("退出成功！请刷新页面")
        }
      }else{
        document.getElementsByTagName("p")[2].innerHTML='<i class="mdui-icon material-icons">&#xe88e;</i>未登录';
      }
    })
  };
  
  document.getElementById("fl").onchange = () => {
    var fileData = document.getElementById("fl").files[0];
    var reader = new FileReader();
    reader.readAsDataURL(fileData);
    reader.onload = function(e) {

    //  document.querySelector("#img").setAttribute("src", e.target.result)
      document.getElementById("example-3").innerHTML='<div class="mdui-spinner mdui-spinner-colorful"></div>请稍等，马上就好'
      mdui.mutation() 
      if (Cookies.get("username")==undefined){
        yhm = "未登录用户"
      }else{
        yhm = Cookies.get("username")
      }
      var data = {
        'im':e.target.result,
        'yhm':yhm,
      }
      $.post("/tp",data=data,function(result){
        if(result=="211"){
          location.reload()
        }else{
          mdui.snackbar("错误！")
        }
      })
 
    }
  }
  
      



  document.getElementById("dl").onclick=function(){
    var data = {
        'yhm':document.getElementById("yhm").value,
        'mm':document.getElementById("mm").value
    }
    $.post("/login",data=data,function(result){
        if(result=="200"){
          Cookies.set("username",document.getElementById("yhm").value,{expires:7})
          Cookies.set("password",document.getElementById("mm").value,{expires:7})
          mdui.snackbar("登陆成功！请刷新页面")
        }else if(result=="122"){
          mdui.snackbar("用户不存在或密码错误")
        }else{
          mdui.snackbar("请求失败，可能是网络问题，请稍后重试")
        }
    })


  };
  document.getElementById("zc").onclick=function(){
    var data = {
        'yhm':document.getElementById("yhm1").value,
        'mm':document.getElementById("mm1").value
    }
    $.post("/register",data=data,function(result){
        if(result=="211"){
          Cookies.set("username",document.getElementById("yhm1").value,{expires:7})
          Cookies.set("password",document.getElementById("mm1").value,{expires:7})
          mdui.snackbar("ok，请刷新页面")
        }else if(result=="152"){
          mdui.snackbar("该用户已存在")
        }else{
          mdui.snackbar("请求失败，可能是网络问题，请稍后重试")
        }
    })


  }



  
  
  var tab = new mdui.Tab('#example4-tab');
  document.getElementById('example-4').addEventListener('open.mdui.dialog', function () {
    tab.handleUpdate();
  });
  var tab1 = new mdui.Tab('#example3-tab');
  document.getElementById('example-3').addEventListener('open.mdui.dialog', function () {
    mdui.snackbar("试试把图片拖到选择文件框～");
    tab1.handleUpdate();
  });
  $.ajaxSetup({
    async: false
  });//全局同步
  $.post("/",data={"p":"0"},function(result){
    result = eval(result)
    window.sjs = result.length
    if(result!="555"){
      var sjxs = "";


      for (var prop in result) {
        
      
        var jl = result[prop]
          
        $.post("/",data={"p":"1","im1":jl["imid"]},function(result){ 
          if(result!="555"){
            sjxs = '<div class="single-cat-item"><img src='+result+'><div class="item-meta"><p>'+jl["name"]+'</p></div></div>'
            document.getElementsByClassName("row")[0].innerHTML = document.getElementsByClassName("row")[0].innerHTML+sjxs
          }
        })

        
      }

    }
    
  })
  setInterval(function(){
    try{
      ps = document.getElementsByTagName("p")[0]
      ps.innerHTML="图片："+a["imid"]+"/"+sjs
    }catch(arr){
      ps.innerHTML="图片正在赶来(或者是没有用户上传)"
    }
  },100)
  
</script>

</body>

</html>